<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CYLO — Read Anything (Offline, One-File)</title>
<style>
:root{
  --bg:#0b0c0f; --panel:#111418; --fg:#e7e8ea; --muted:#a5aab3; --ok:#8dd47d; --bad:#f26d6d; --pill:#222730;
  --hi:#66a6ff;
}
*{box-sizing:border-box} html,body{height:100%} body{
  margin:0; background:var(--bg); color:var(--fg); font:14px ui-sans-serif,system-ui,Segoe UI,Arial;
}
.app{max-width:980px; margin:0 auto; padding:18px 14px 80px}
h1{margin:6px 0 14px; font-weight:700; letter-spacing:.3px}
.card{background:var(--panel); border:1px solid #1e2126; border-radius:12px; padding:16px; margin:12px 0}
.row{display:flex; gap:10px; flex-wrap:wrap}
button,.pill,input[type=file]{background:#0f1116; color:var(--fg); border:1px solid #2a2f37;
  border-radius:999px; padding:10px 14px; cursor:pointer}
button:hover{border-color:#3a4250}
.pill{background:var(--pill);}
.ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
.small{font-size:12px}
#out,#log{white-space:pre-wrap}
pre{white-space:pre-wrap; margin:0; font:13px ui-monospace,Menlo,Consolas,monospace; color:#eaeef6}
table{border-collapse:collapse; width:100%} th,td{border:1px solid #2a2f37; padding:6px 8px}
img,iframe,video{max-width:100%}
.footer{position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg,transparent,rgba(0,0,0,.5));
  padding:10px 14px}
.badge{display:inline-block; padding:6px 10px; border:1px solid #2a2f37; border-radius:8px; margin-right:6px}
/* iPad PWA feel */
</style>
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#0b0c0f">
<body>
<div class="app">
  <h1>CYLO — Read Anything <span class="muted small">(offline • one-file)</span></h1>

  <div class="card">
    <div class="row">
      <input id="picker" type="file" multiple aria-label="Choose files to view">
      <button id="btnSnap">Save Capsule Snapshot</button>
      <span class="pill small">Capsules: <span id="capCount">0</span></span>
      <span class="pill small">Offline: <span class="ok">ON</span></span>
    </div>
    <div class="small muted" style="margin-top:8px">
      Supports: TXT / MD / JSON / CSV / HTML / XML / PNG / JPG / GIF / WEBP / HEIC* / PDF*. <br>
      <span class="muted">(*PDF/HEIC render via system viewer in Edge iOS.)</span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <span class="badge">LearnOnce</span>
      <span class="badge">WorkOnce</span>
      <span class="badge">Reflect</span>
      <span class="badge">Expand</span>
      <span class="badge">Foresight</span>
      <span class="badge">50/50 → 01</span>
    </div>
  </div>

  <div class="card">
    <div class="row"><strong>Output</strong></div>
    <div id="out" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row"><strong>Event Log</strong></div>
    <pre id="log"></pre>
  </div>
</div>

<div class="footer small muted">
  Tip: In Edge, tap “•••” → <b>Add to Home Screen</b> to use like an app (works offline).
</div>

<script>
const $ = sel => document.querySelector(sel);
const out = $('#out'), log = $('#log'), capCountEl = $('#capCount');

const state = {
  capsules: Number(localStorage.getItem('caps.count')||0)
};
capCountEl.textContent = state.capsules;

function logLine(s){ log.textContent += s + "\n"; log.scrollTop = log.scrollHeight; }

function ext(name){ const i=name.lastIndexOf('.'); return i>=0? name.slice(i+1).toLowerCase() : ''; }

function prettyJSON(obj){
  return "<pre>"+escapeHTML(JSON.stringify(obj,null,2))+"</pre>";
}
function escapeHTML(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function mdToHTML(md){
  // Tiny markdown: headings, bold, italics, code, links, lists
  return "<div>"+escapeHTML(md)
    .replace(/^###### (.*)$/gm,'<h6>$1</h6>')
    .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
    .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
    .replace(/^### (.*)$/gm,'<h3>$1</h3>')
    .replace(/^## (.*)$/gm,'<h2>$1</h2>')
    .replace(/^# (.*)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/\*(.*?)\*/g,'<i>$1</i>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/$begin:math:display$([^$end:math:display$]+)\]$begin:math:text$([^)]+)$end:math:text$/g,'<a href="$2">$1</a>')
    .replace(/^\s*[-*] (.*)$/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>')
    .replace(/\n\n/g,'<br><br>')+"</div>";
}
function csvToTable(text){
  // Simple CSV (commas, no full RFC parsing to keep code small)
  const rows = text.replace(/\r/g,'').split('\n').filter(r=>r.length);
  const cells = rows.map(r=> r.split(','));
  let html = '<table><tbody>';
  for(const row of cells){
    html += '<tr>'+ row.map(c=>'<td>'+escapeHTML(c)+'</td>').join('') +'</tr>';
  }
  html += '</tbody></table>';
  return html;
}

async function handleFile(file){
  const e = ext(file.name);
  logLine(`↪︎ Importing "${file.name}" (${file.type||'unknown'})`);

  // Create object URL for binary previews
  const url = URL.createObjectURL(file);

  if (['png','jpg','jpeg','gif','webp','heic'].includes(e)){
    out.innerHTML = `<div class="small muted">${escapeHTML(file.name)}</div><img src="${url}" alt="">`;
    return;
  }
  if (e==='pdf' || file.type==='application/pdf'){
    out.innerHTML = `<div class="small muted">${escapeHTML(file.name)}</div><iframe src="${url}" style="width:100%;height:70vh;border:1px solid #2a2f37;border-radius:10px"></iframe>`;
    return;
  }

  // Text-like
  const text = await file.text();

  if (e==='md'){
    out.innerHTML = `<div class="small muted">${escapeHTML(file.name)}</div>` + mdToHTML(text);
    return;
  }
  if (e==='csv'){
    out.innerHTML = `<div class="small muted">${escapeHTML(file.name)}</div>` + csvToTable(text);
    return;
  }
  if (e==='json'){
    try{ out.innerHTML = prettyJSON(JSON.parse(text)); }
    catch(err){ out.innerHTML = "<pre>"+escapeHTML(text)+"</pre>"; }
    return;
  }
  // CHANGED: render html/xml via iframe instead of showing source
  if (e==='html' || e==='xml'){
    out.innerHTML =
      `<div class="small muted">${escapeHTML(file.name)}</div>`+
      `<iframe src="${url}" style="width:100%;height:70vh;border:1px solid #2a2f37;border-radius:10px"></iframe>`;
    return;
  }
  // default: plain text
  out.innerHTML = "<pre>"+escapeHTML(text)+"</pre>";
}

$('#picker').addEventListener('change', async ev=>{
  const files = ev.target.files;
  for (const f of files) await handleFile(f);
  logLine(`✓ Loaded ${files.length} file(s).`);
});

$('#btnSnap').addEventListener('click', ()=>{
  // Minimal Capsule snapshot
  const stamp = new Date().toISOString();
  const snapshot = {
    anchor: `TAP-${Date.now()}`,
    time: stamp,
    doctrine: "Learn→Work→Reflect→Expand→Foresight • 50/50→01",
    note: "Local-only snapshot (no upload).",
  };
  const snaps = JSON.parse(localStorage.getItem('caps.log')||'[]');
  snaps.push(snapshot);
  localStorage.setItem('caps.log', JSON.stringify(snaps));
  state.capsules += 1;
  localStorage.setItem('caps.count', state.capsules);
  capCountEl.textContent = state.capsules;
  logLine(`★ Snapshot saved @ ${stamp}`);
});
</script>
</html>
